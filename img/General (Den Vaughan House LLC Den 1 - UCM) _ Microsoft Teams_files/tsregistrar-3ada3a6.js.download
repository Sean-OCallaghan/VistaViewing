!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("@skype/tsregistrar",[],e):"object"==typeof exports?exports["@skype/tsregistrar"]=e():t["@skype/tsregistrar"]=e()}(this,function(){return function(t){function e(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return t[n].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var r={};return e.m=t,e.c=r,e.i=function(t){return t},e.d=function(t,r,n){e.o(t,r)||Object.defineProperty(t,r,{configurable:!1,enumerable:!0,get:n})},e.n=function(t){var r=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(r,"a",r),r},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=1)}([function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.toJson=function(t){try{return JSON.stringify(t)}catch(e){return"Unable to serialize object of type "+typeof t}};var n=function(){function t(){this.start=Date.now()}return Object.defineProperty(t.prototype,"duration",{get:function(){return Date.now()-this.start},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"startTime",{get:function(){return this.start},enumerable:!0,configurable:!0}),t.prototype.reset=function(){this.start=Date.now()},t}();e.Timespan=n},function(t,e,r){"use strict";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),o=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))(function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function a(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){t.done?o(t.value):new r(function(e){e(t.value)}).then(s,a)}c((n=n.apply(t,e||[])).next())})},i=this&&this.__generator||function(t,e){function r(t){return function(e){return n([t,e])}}function n(r){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,i&&(s=2&r[0]?i.return:r[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,r[1])).done)return s;switch(i=0,s&&(r=[2&r[0],s.value]),r[0]){case 0:case 1:s=r;break;case 4:return c.label++,{value:r[1],done:!1};case 5:c.label++,i=r[1],r=[0];continue;case 7:r=c.ops.pop(),c.trys.pop();continue;default:if(s=c.trys,!(s=s.length>0&&s[s.length-1])&&(6===r[0]||2===r[0])){c=0;continue}if(3===r[0]&&(!s||r[1]>s[0]&&r[1]<s[3])){c.label=r[1];break}if(6===r[0]&&c.label<s[1]){c.label=s[1],s=r;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(r);break}s[2]&&c.ops.pop(),c.trys.pop();continue}r=e.call(t,c)}catch(t){r=[6,t],i=0}finally{o=s=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}var o,i,s,a,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a};Object.defineProperty(e,"__esModule",{value:!0});var s=r(0),a=function(t){function e(e){var r=t.call(this,e)||this;return r.name="CancelationError",r}return n(e,t),e}(Error),c=function(){function t(e,r,n){this.logger=e,this.maxBackoffInMs=r,this.initialDelay=n,this.backoffCount=0,this.id=++t.idCounter}return t.prototype.delay=function(t){var e=this;if(void 0!==this.timerHandle)throw new Error("Retry sequence logical failure");if(-1===this.backoffCount)return new Promise(function(t,e){e(new a("Cancelled"))});var r=this.calculateNextBackoffMs();return this.backoffCount++,this.logger.info("[RegistrarClient] Backing off "+t+" for "+r+" milliseconds with ID "+this.id),new Promise(function(n,o){e.cancelFunc=o,e.timerHandle=setTimeout(function(){e.logger.info("[RegistrarClient] Back off for "+t+" with ID "+e.id+" complete"),e.timerHandle=void 0,n()},r)})},t.prototype.cancel=function(){void 0!==this.timerHandle&&(this.logger.debug("Resetting back off"),clearTimeout(this.timerHandle),void 0!==this.cancelFunc&&this.cancelFunc(new a("Cancelled"))),this.backoffCount=-1},t.prototype.calculateNextBackoffMs=function(){var t=1+.4*(Math.random()-.5),e=this.initialDelay*Math.pow(2,this.backoffCount)*t;return e=Math.round(e),Math.min(this.maxBackoffInMs,e)},t.idCounter=0,t}(),u=function(){function t(t,e,r){this.logger=t,this.skypeTokenProvider=e,this.options=r,this.backoffs={}}return t.prototype.setTelemetryLogger=function(t){this.eventLogger=t},t.prototype.register=function(t,e){return o(this,void 0,void 0,function(){return i(this,function(r){switch(r.label){case 0:return[4,this.performRegistration(t,e,"pr_set_registration")];case 1:return r.sent(),this.cachedRegistrationParams=[t,e],[2]}})})},t.prototype.unregister=function(){return o(this,void 0,void 0,function(){var t;return i(this,function(e){switch(e.label){case 0:return this.logger.info("[RegistrarClient] sending unregister request"),t=new Request(this.options.registrarUrl+"/"+this.options.registrationId,{method:"DELETE",mode:"cors",headers:new Headers({accept:"application/json, text/javascript"})}),[4,this.callRegistrar(t,"pr_delete_registration")];case 1:return e.sent(),[2]}})})},t.prototype.cancelPendingRequests=function(){var t=this;Object.keys(this.backoffs).forEach(function(e){t.backoffs[e].cancel()}),this.backoffs={}},t.prototype.resendRegistration=function(){return o(this,void 0,void 0,function(){return i(this,function(t){switch(t.label){case 0:if(!this.cachedRegistrationParams)throw new Error("Re-registration failed because there is no registration parameters cached");return[4,this.performRegistration(this.cachedRegistrationParams[0],this.cachedRegistrationParams[1],"pr_resend_registration")];case 1:return t.sent(),[2]}})})},t.prototype.performRegistration=function(t,e,r){return o(this,void 0,void 0,function(){var n,o;return i(this,function(i){switch(i.label){case 0:return this.logger.info("[RegistrarClient] Sending register request"),n={clientDescription:t,registrationId:this.options.registrationId,nodeId:"",transports:e},o=new Request(this.options.registrarUrl,{method:"POST",mode:"cors",headers:new Headers({"content-type":"application/json",accept:"application/json, text/javascript"}),body:s.toJson(n)}),[4,this.callRegistrar(o,r)];case 1:return i.sent(),[2]}})})},t.prototype.startBackoff=function(){var t=new c(this.logger,this.options.maxRetryDelayMs,this.options.initialRetryDelayMs);return this.backoffs[t.id]=t,t},t.prototype.stopBackoff=function(t){t.cancel(),delete this.backoffs[t.id]},t.prototype.getSkypeToken=function(){return o(this,void 0,void 0,function(){var t,e,r,n;return i(this,function(o){switch(o.label){case 0:t=this.startBackoff(),o.label=1;case 1:return o.trys.push([1,3,,8]),this.logger.info("[RegistrarClient] Asking for a new skypetoken"),[4,this.skypeTokenProvider(!0)];case 2:return e=o.sent(),this.stopBackoff(t),[2,e];case 3:r=o.sent(),o.label=4;case 4:return o.trys.push([4,6,,7]),[4,t.delay("Fetching a new skypetoken")];case 5:return o.sent(),[3,8];case 6:throw n=o.sent(),this.stopBackoff(t),n;case 7:return[3,8];case 8:return[3,1];case 9:return[2]}})})},t.prototype.callRegistrar=function(t,e){return o(this,void 0,void 0,function(){var r,n,o,a,c,u,f,l,h;return i(this,function(i){switch(i.label){case 0:return r=this.startBackoff(),[4,this.skypeTokenProvider(!1)];case 1:n=i.sent(),this.setSkypeTokenHeader(t,n),o=new s.Timespan,i.label=2;case 2:a=void 0,i.label=3;case 3:return i.trys.push([3,8,13,14]),c=t.clone(),[4,this.fetchWithTimeout(c)];case 4:return 401!==(a=i.sent()).status?[3,6]:(u=this.setSkypeTokenHeader,f=[t],[4,this.getSkypeToken()]);case 5:return u.apply(this,f.concat([i.sent()])),[3,15];case 6:if(a.status>=500&&a.status<600)throw new Error("Fetch for '"+t.url+"' failed with "+a.status+" "+a.statusText);i.label=7;case 7:return[3,14];case 8:l=i.sent(),this.logger.error("[RegistrarClient] Request failed with "+l),i.label=9;case 9:return i.trys.push([9,11,,12]),[4,r.delay("Registrar call retry")];case 10:return i.sent(),[3,15];case 11:throw h=i.sent(),this.logger.error("[RegistrarClient] Request cancelled"),this.stopBackoff(r),h;case 12:return[3,14];case 13:return this.sendTelemetryEvent(e,t,a,o),[7];case 14:if(this.stopBackoff(r),a.ok)return[2,a];throw new Error("Fetch for '"+t.url+"' failed with "+a.status+" "+a.statusText);case 15:return[3,2];case 16:return[2]}})})},t.prototype.setSkypeTokenHeader=function(t,e){t.headers.set("X-Skypetoken",e)},t.prototype.fetchWithTimeout=function(t){var e=this;return new Promise(function(r,n){fetch(t).then(r).catch(n),0!==e.options.requestTimeoutMs&&setTimeout(n,e.options.requestTimeoutMs,new Error("Fetch for '"+t.url+"' timed out"))})},t.prototype.sendTelemetryEvent=function(t,e,r,n){if(void 0!==this.eventLogger){var o={name:t,properties:{url:{value:e.url},result_code:{value:void 0!==r?r.status:0},begin_timestamp:{value:n.startTime},elapsed:{value:n.duration}}};this.eventLogger.logEvent(o)}},t}();e.RegistrarClient=u,e.createRegistrarClient=function(t,e,r){return new u(t,e,r)}}])});